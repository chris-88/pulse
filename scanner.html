<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-gray-900">
    <div
      id="scannerContainer"
      class="max-w-3xl mx-auto p-6 mt-10 bg-white shadow-lg rounded-md transition-all duration-300"
    >
      <h1 class="text-3xl font-bold text-center mb-4">Pulse Scanner</h1>
      <p class="text-center text-gray-600 mb-4">
        Click the toggle below to start or stop scanning.
      </p>

      <!-- Event + Mode Controls -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <div>
          <label
            for="eventInput"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Event Name</label
          >
          <input
            id="eventInput"
            type="text"
            placeholder="e.g. Charity Run 2025"
            class="w-full px-3 py-2 border border-gray-300 rounded-md"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Mode</label
          >
          <button
            id="modeToggle"
            onclick="toggleMode()"
            class="w-full px-4 py-2 font-semibold rounded-md bg-green-600 text-white hover:bg-green-700 transition"
          >
            Mode: Sign In
          </button>
        </div>
      </div>

      <!-- Scanning Toggle -->
      <div class="text-center mb-6">
        <button
          id="toggleScan"
          class="px-6 py-2 font-semibold rounded-md bg-blue-600 text-white hover:bg-blue-700 transition"
        >
          Start Scanning
        </button>
      </div>

      <video id="video" autoplay playsinline style="display: none"></video>

      <!-- Bib Assignment Form -->
      <div
        id="bibForm"
        class="hidden bg-yellow-50 border border-yellow-300 p-4 rounded-md mb-6"
      >
        <h2 class="font-semibold text-lg mb-2">Assign Bib Number</h2>
        <p id="bibDetails" class="text-sm mb-2 text-gray-700"></p>
        <input
          id="bibInput"
          type="text"
          placeholder="Enter Bib Number"
          class="w-full px-3 py-2 border border-gray-300 rounded-md mb-3"
        />
        <button
          onclick="submitBib()"
          class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-md transition"
        >
          Confirm Entry
        </button>
      </div>

      <!-- Scanned Entries Table -->
      <div id="scannedSection" class="mb-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Scanned Entries</h2>
        <div class="overflow-x-auto rounded-md border">
          <table class="w-full text-sm text-left text-gray-700">
            <thead class="bg-gray-100 border-b text-gray-700">
              <tr>
                <th class="px-4 py-2 text-left">Event</th>
                <th class="px-4 py-2 text-left">Name</th>
                <th class="px-4 py-2 text-left">License</th>
                <th class="px-4 py-2 text-left">Bib</th>
                <th class="px-4 py-2 text-left">Start</th>
                <th class="px-4 py-2 text-left">Finish</th>
                <th class="px-4 py-2 text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="scannedTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-4 mb-4">
        <button
          onclick="downloadCSV()"
          class="flex-1 bg-gray-500 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md transition"
        >
          Download CSV
        </button>
        <button
          onclick="resetAll()"
          class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-md transition"
        >
          Reset All Data
        </button>
      </div>

      <p id="errorMsg" class="text-center text-red-600 mt-4 hidden"></p>
    </div>

    <script>
      const video = document.getElementById("video");
      const toggleBtn = document.getElementById("toggleScan");
      const container = document.getElementById("scannerContainer");
      const bibForm = document.getElementById("bibForm");
      const bibDetails = document.getElementById("bibDetails");
      const bibInput = document.getElementById("bibInput");
      const errorMsg = document.getElementById("errorMsg");
      const scannedSection = document.getElementById("scannedSection");
      const scannedTableBody = document.getElementById("scannedTableBody");

      let codeReader;
      let isScanning = false;
      let currentParticipant = null;
      let scannedEntries = [];
      let currentMode = "signin"; // "signin" or "signout"
      let currentEvent = "";

      // Load from localStorage
      window.onload = () => {
        const saved = localStorage.getItem("scannedEntries");
        if (saved) {
          scannedEntries = JSON.parse(saved);
          scannedSection.classList.remove("hidden");
          scannedEntries.forEach((entry) => appendTableRow(entry));
        }
      };

      toggleBtn.addEventListener("click", () => {
        isScanning ? stopScanner() : startScanner();
      });

      function startScanner() {
        navigator.mediaDevices
          .getUserMedia({ video: { facingMode: "environment" } })
          .then((stream) => {
            video.srcObject = stream;
            video.play();

            codeReader = new ZXing.BrowserQRCodeReader();

            codeReader.decodeFromVideoElementContinuously(
              video,
              (result, err) => {
                if (result && !currentParticipant) {
                  try {
                    const payload = result.getText();
                    const [name, email] = atob(payload)
                      .split("|")
                      .map((str) => str.trim());

                    if (currentMode === "signin") {
                      // Block duplicate QR code
                      if (scannedEntries.find((e) => e.code === payload)) {
                        showToast(
                          "This QR code has already been scanned.",
                          "error"
                        );
                        return;
                      }

                      // Block same email used by a different person
                      const existing = scannedEntries.find(
                        (e) => e.email === email
                      );
                      if (existing && existing.name !== name) {
                        showToast(
                          `This license number is already used by "${existing.name}".`,
                          "error"
                        );
                        return;
                      }
                    } else if (currentMode === "signout") {
                      const existing = scannedEntries.find(
                        (e) =>
                          e.email === email &&
                          e.event ===
                            document
                              .getElementById("eventInput")
                              .value.trim() &&
                          !e.finishTime
                      );

                      if (!existing) {
                        showToast(
                          "This user hasn't signed in or is already signed out.",
                          "error"
                        );
                        return;
                      }
                    }

                    currentParticipant = { name, email, code: payload };
                    showBibForm(name, email);
                    clearError();
                  } catch {
                    showToast("Invalid QR code format.", "error");
                  }
                }
              }
            );

            isScanning = true;
            updateUIState();
          })
          .catch((err) => {
            showToast("Camera error: " + err, "error");
          });
      }

      function stopScanner() {
        if (codeReader) {
          codeReader.reset();
          codeReader = null;
        }
        if (video.srcObject) {
          video.srcObject.getTracks().forEach((track) => track.stop());
          video.srcObject = null;
        }

        isScanning = false;
        updateUIState();
      }

      function updateUIState() {
        toggleBtn.textContent = isScanning ? "Stop Scanning" : "Start Scanning";
        toggleBtn.classList.toggle("bg-blue-600", !isScanning);
        toggleBtn.classList.toggle("hover:bg-blue-700", !isScanning);
        toggleBtn.classList.toggle("bg-red-600", isScanning);
        toggleBtn.classList.toggle("hover:bg-red-700", isScanning);

        container.classList.toggle("border-4", isScanning);
        container.classList.toggle("border-green-500", isScanning);
      }

      function showBibForm(name, email) {
        bibDetails.textContent = `Name: ${name} | Email: ${email}`;

        if (currentMode === "signin") {
          bibForm.classList.remove("hidden");
          bibInput.focus();
        } else if (currentMode === "signout") {
          // Auto-submit for sign-out, no bib required
          submitBib();
        }
      }

      function submitBib() {
        currentEvent = document.getElementById("eventInput").value.trim();

        if (!currentEvent) {
          showToast("Please enter an event name first.", "error");
          return;
        }

        const timestamp = new Date().toISOString();

        if (currentMode === "signin") {
          const bib = bibInput.value.trim();
          if (!bib) {
            alert("Please enter a bib number.");
            return;
          }

          const entry = {
            ...currentParticipant,
            bib,
            event: currentEvent,
            startTime: timestamp,
            finishTime: "",
          };

          scannedEntries.push(entry);
          localStorage.setItem(
            "scannedEntries",
            JSON.stringify(scannedEntries)
          );
          appendTableRow(entry);
          showToast(`Signed in: ${entry.name}`, "success");
          scannedSection.classList.remove("hidden");
        } else if (currentMode === "signout") {
          const existing = scannedEntries.find(
            (e) =>
              e.email === currentParticipant.email &&
              e.event === currentEvent &&
              !e.finishTime
          );

          if (existing) {
            existing.finishTime = timestamp;
            localStorage.setItem(
              "scannedEntries",
              JSON.stringify(scannedEntries)
            );
            rebuildTable();
            showToast(`Signed out: ${existing.name}`, "info");
          } else {
            showToast(
              "This user hasn't signed in or is already signed out.",
              "error"
            );
          }
        }

        currentParticipant = null;
        bibInput.value = "";
        bibForm.classList.add("hidden");
      }

      function appendTableRow(entry) {
        const row = document.createElement("tr");
        const formatTime = (iso) => {
          if (!iso) return "";
          const d = new Date(iso);
          return d.toLocaleTimeString("en-GB", { hour12: false }); // 24-hour format
        };

        row.innerHTML = `
  <td class="px-4 py-2">${entry.event}</td>
  <td class="px-4 py-2">${entry.name}</td>
  <td class="px-4 py-2">${entry.email}</td>
  <td class="px-4 py-2">${entry.bib || ""}</td>
  <td class="px-4 py-2">${formatTime(entry.startTime)}</td>
  <td class="px-4 py-2">${formatTime(entry.finishTime)}</td>
  <td class="px-4 py-2 text-right">
    <button onclick="removeEntry('${
      entry.code
    }')" class="text-red-600 hover:underline">Remove</button>
  </td>
`;

        scannedTableBody.appendChild(row);
      }

      function rebuildTable() {
        scannedTableBody.innerHTML = "";
        scannedEntries.forEach(appendTableRow);
      }

      function downloadCSV() {
        if (!scannedEntries.length) {
          alert("No entries to download.");
          return;
        }

        const csv =
          "data:text/csv;charset=utf-8," +
          ["Name,Email,Bib Number,Timestamp"]
            .concat(
              scannedEntries.map(
                (e) => `"${e.name}","${e.email}","${e.bib}","${e.timestamp}"`
              )
            )
            .join("\n");

        const encodedUri = encodeURI(csv);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "scanned_entries.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function clearError() {
        errorMsg.textContent = "";
        errorMsg.classList.add("hidden");
      }

      function resetAll() {
        if (!confirm("Are you sure you want to delete all scanned entries?"))
          return;

        scannedEntries = [];
        localStorage.removeItem("scannedEntries");
        scannedTableBody.innerHTML = "";
        scannedSection.classList.add("hidden");
      }

      function removeEntry(code) {
        if (!confirm("Remove this entry?")) return;

        scannedEntries = scannedEntries.filter((e) => e.code !== code);
        localStorage.setItem("scannedEntries", JSON.stringify(scannedEntries));

        // Clear and rebuild table
        scannedTableBody.innerHTML = "";
        scannedEntries.forEach((entry) => appendTableRow(entry));

        if (scannedEntries.length === 0) {
          scannedSection.classList.add("hidden");
        }
      }

      function showToast(message, type = "error") {
        const toast = document.getElementById("toast");
        const toastMsg = document.getElementById("toastMessage");

        toastMsg.textContent = message;

        // Reset and apply styles
        toast.classList.remove("bg-red-600", "bg-green-600", "bg-blue-600");
        if (type === "error") toast.classList.add("bg-red-600");
        else if (type === "success") toast.classList.add("bg-green-600");
        else if (type === "info") toast.classList.add("bg-blue-600");

        // Play sound
        const soundId = {
          success: "sound-success",
          info: "sound-info",
          error: "sound-error",
        }[type];

        const audio = document.getElementById(soundId);
        if (audio) {
          audio.currentTime = 0;
          audio.play().catch(() => {}); // Just in case autoplay is blocked
        }

        // Show toast
        toast.classList.add("opacity-100");

        setTimeout(() => {
          toast.classList.remove("opacity-100");
        }, 3000);
      }

      function toggleMode() {
        currentMode = currentMode === "signin" ? "signout" : "signin";
        const btn = document.getElementById("modeToggle");

        if (currentMode === "signin") {
          btn.textContent = "Mode: Sign In";
          btn.classList.remove("bg-yellow-600", "hover:bg-yellow-700");
          btn.classList.add("bg-green-600", "hover:bg-green-700");
        } else {
          btn.textContent = "Mode: Sign Out";
          btn.classList.remove("bg-green-600", "hover:bg-green-700");
          btn.classList.add("bg-yellow-600", "hover:bg-yellow-700");
        }
      }
    </script>
    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white text-sm font-medium px-4 py-2 rounded shadow-lg opacity-0 transition-opacity duration-300 z-50"
    >
      <span id="toastMessage"></span>
    </div>

    <!-- Toast Sounds -->
    <audio
      id="sound-error"
      src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"
      preload="auto"
    ></audio>
    <audio
      id="sound-info"
      src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"
      preload="auto"
    ></audio>
    <audio
      id="sound-success"
      src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
      preload="auto"
    ></audio>
  </body>
  <!-- Toast Notification -->
  <div
    id="toast"
    class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white text-sm font-medium px-4 py-2 rounded shadow-lg opacity-0 transition-opacity duration-300 z-50"
  >
    <span id="toastMessage"></span>
  </div>
</html>
